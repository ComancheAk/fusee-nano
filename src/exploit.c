#include <stdio.h>
#include <unistd.h>
#include "usb.h"

/* Nintendo Switch RCM Mode VID/PID */
#define APX_VID 0x0955
#define APX_PID 0x7321

#define TIMEOUT 1000 // milliseconds

#define MAX_LENGTH 0x30298 // length of the exploit packet

static void print_hex(unsigned char *buf, int len)
{
	for (int i=0; i<len; i++)
		printf("%02x", buf[i]);
}

int main()
{
	int fd;
	unsigned char devid[16];
	
	fd = get_device(APX_VID, APX_PID);
	if (fd < 0) {
		perror("[-] Failed to open usb device");
		close(fd);
		return -1;
	}
	
	if(claim_interface(fd) < 0) {
		perror("[-] Failed to claim interface");
		close(fd);
		return -1;
	}
	
	if (ep_read(fd, 1, devid, sizeof(devid), TIMEOUT) != sizeof(devid)) {
		perror("[-] Failed to read device ID");
		close(fd);
		return -1;
	}
	
	printf("[*] device id: ");
	print_hex(devid, sizeof(devid));
	printf("\n");
	
	printf("smash: %d\n", ctrl_transfer_unbounded(fd, MAX_LENGTH));
	
	close(fd);
	return 0;
}
